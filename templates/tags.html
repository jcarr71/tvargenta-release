<!-- SPDX-License-Identifier: LicenseRef-TVArgenta-NC-Attribution-Consult-First
     Proyecto: TVArgenta â€” Retro TV | Autor: Ricardo Sappia (rsflightronics@gmail.com)
     Â© 2025. No comercial, atribuciÃ³n y consulta previa. TAL CUAL, sin garantÃ­as.
     Ver LICENSE para tÃ©rminos completos.
-->
<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
  <meta charset="UTF-8">
  <title>{{ tr("tags.page_title") }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .pill { display:inline-flex; align-items:center; gap:.5rem; padding:.375rem .75rem; border-radius:9999px;
            background:#fff; color:#000; font-weight:700; font-size:.8rem; }
    .section { border:1px solid rgba(234,179,8,.3); background:rgba(17,24,39,.5); }
    .collapse-btn { cursor:pointer; }
    .hide { display:none !important; }
    .sticky-bar { position:sticky; bottom:0; z-index:30; background:rgba(0,0,0,.85); backdrop-filter: blur(6px);
                  border-top:1px solid rgba(255,255,255,.12); }
    .input { background:#111827; color:#fff; border:1px solid #4b5563; border-radius:.5rem; padding:.5rem .75rem; }
    .input:focus { outline:none; border-color:#f59e0b; }
  </style>
</head>
<body class="bg-black text-white font-mono min-h-screen">
  <div class="max-w-screen-lg mx-auto py-6 sm:py-8 px-3 sm:px-6">

<header class="flex items-center justify-between mb-4 sm:mb-6">
  <h1 class="text-2xl sm:text-3xl font-bold text-yellow-400">
    {{ tr("tags.header") }}
  </h1>

  <div class="flex items-center gap-4">
    {% if return_to %}
      <a href="{{ url_for('edit_video', video_id=return_to) }}"
         class="text-blue-400 underline text-sm sm:text-base">
        {{ tr("tags.nav.back_edit") }}
      </a>
    {% else %}
      <a href="{{ url_for('index') }}"
         class="text-blue-400 underline text-sm sm:text-base">
        {{ tr("tags.nav.back_home") }}
      </a>
    {% endif %}

    <!-- Selector de idioma -->
    <select id="tags-lang-select"
            class="bg-gray-900 border border-gray-600 text-xs sm:text-sm px-2 py-1 rounded">
      <option value="es">ðŸ‡¦ðŸ‡· ES</option>
      <option value="en">ðŸ‡ºðŸ‡¸ EN</option>
      <option value="de">ðŸ‡©ðŸ‡ª DE</option>
    </select>
  </div>
</header>

    <!-- Buscador global -->
    <div class="mb-4 sm:mb-6">
      <label class="block text-xs sm:text-sm text-gray-300 mb-1">{{ tr("tags.search.label") }}</label>
      <input id="buscarGlobal" type="text" placeholder="{{ tr('tags.search.placeholder') }}"
             class="input w-full sm:w-96" />
      <p class="text-[11px] sm:text-xs text-gray-400 mt-1">{{ tr("tags.search.help") }}</p>
    </div>

    <!-- NUEVO GRUPO -->
    <form action="/add_group" method="post" class="section rounded-lg p-3 sm:p-4 mb-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg sm:text-xl font-bold text-yellow-300">{{ tr("tags.group.new.title") }}</h2>
        <button type="button" class="collapse-btn text-xs bg-gray-800 border border-gray-600 hover:border-yellow-500 rounded px-3 py-1.5"
                data-target="#bodyAddGroup">{{ tr("tags.group.new.toggle_show") }}/{{ tr("tags.group.new.toggle_hide") }}</button>
      </div>

      <div id="bodyAddGroup" class="mt-3">
        <div class="grid grid-cols-1 sm:grid-cols-[1fr_auto_auto] gap-3 items-center">
          <input type="text" name="group" placeholder={{ tr("tags.group.new.name_placeholder") }} class="input w-full" required>
          <input type="color" name="color" class="w-10 h-10 border-2 border-white rounded place-self-start sm:place-self-auto" value="#f59e0b">
          <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold">{{ tr("tags.group.new.create_btn") }}</button>
        </div>
      </div>
    </form>

    <!-- NUEVO TAG -->
    <form action="/add_tag" method="post" class="section rounded-lg p-3 sm:p-4 mb-8">
      <div class="flex items-center justify-between">
        <h2 class="text-lg sm:text-xl font-bold text-yellow-300">{{ tr("tags.tag.new.title") }}</h2>
        <button type="button" class="collapse-btn text-xs bg-gray-800 border border-gray-600 hover:border-yellow-500 rounded px-3 py-1.5"
                data-target="#bodyAddTag">{{ tr("tags.group.new.toggle_show") }}/{{ tr("tags.group.new.toggle_hide") }}</button>
      </div>

      <div id="bodyAddTag" class="mt-3">
        <div class="grid grid-cols-1 sm:grid-cols-[1fr_auto_auto] gap-3 items-center">
          <input type="text" name="tag" placeholder={{ tr("tags.tag.new.name_placeholder") }} class="input w-full" required>
          <select name="group" class="input w-full sm:w-auto">
            {% for group, info in tags.items() %}
              <option value="{{ group }}">{{ group }}</option>
            {% endfor %}
          </select>
          <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold">{{ tr("tags.tag.new.add_btn") }}</button>
        </div>
      </div>
    </form>

    <!-- LISTA DE GRUPOS -->
    <div id="groupsWrap" class="space-y-6 sm:space-y-8">
      {% for group, info in tags.items() %}
      <section class="bg-gray-900 p-3 sm:p-4 rounded border-l-4" style="border-color: {{ info.color }};">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-2">
          <div class="flex items-center gap-3">
            <h2 class="text-lg sm:text-xl font-bold group-title" style="color: {{ info.color }}">{{ group }}</h2>
            <span class="text-[11px] sm:text-xs text-gray-300">
              <span class="count-visible">0</span>/<span class="count-total">0</span>
            </span>
          </div>

          <div class="flex items-center gap-2 flex-wrap">
            <!-- Form inline para agregar tag directo a este grupo -->
            <form action="/add_tag" method="post" class="flex items-center gap-2"
                  onsubmit="return this.tag.value.trim().length > 0;">
              <input type="hidden" name="group" value="{{ group }}">
              <input name="tag" type="text"
			   placeholder="{{ tr('tags.group.inline.new_tag_placeholder').replace('{group}', group)|escape }}"
			   class="input w-40 sm:w-56">
              {% if request.args.get('from_edit') %}
                <input type="hidden" name="from_edit" value="{{ request.args.get('from_edit') }}">
              {% endif %}
              <button type="submit" class="text-xs sm:text-sm bg-green-700 hover:bg-green-800 px-3 py-1.5 rounded">{{ tr("tags.tag.new.add_btn") }}</button>
            </form>

            <!-- Cambiar color del grupo -->
            <form action="/update_group_color" method="post" class="flex items-center gap-2">
              <input type="hidden" name="group" value="{{ group }}">
              {% if request.args.get('from_edit') %}
                <input type="hidden" name="from_edit" value="{{ request.args.get('from_edit') }}">
              {% endif %}
              <label class="text-[11px] sm:text-xs text-gray-300">{{ tr("tags.group.color.label") }}</label>
              <input type="color" name="color" value="{{ info.color or '#cccccc' }}"
                     class="w-8 h-8 border border-white rounded group-color-picker">
              <button type="submit"
                      class="text-xs sm:text-sm bg-yellow-600 hover:bg-yellow-700 text-black px-3 py-1.5 rounded">
                Guardar
              </button>
            </form>

            <!-- Eliminar grupo -->
            <form method="POST" action="{{ url_for('delete_group') }}" class="inline"
                  onsubmit="return confirm('{{ tr('tags.group.delete.confirm').replace('{group}', group)|tojson }}')">
              <input type="hidden" name="group" value="{{ group }}">
              <input type="hidden" name="from_edit" value="{{ request.args.get('from_edit', '') }}">
              <button type="submit" class="text-red-400 text-xs hover:underline">{{ tr("tags.group.delete.btn") }}</button>
            </form>

            <!-- Toggle colapso -->
            <button type="button" class="collapse-btn text-xs bg-gray-800 border border-gray-600 hover:border-yellow-500 rounded px-2 py-1.5"
                    data-target="#body-{{ loop.index0 }}">{{ tr("tags.collapse.show") }}/{{ tr("tags.collapse.hide") }}</button>
          </div>
        </div>

        <div id="body-{{ loop.index0 }}" class="mt-2">
          <ul class="flex flex-wrap gap-2">
            {% for tag in info.tags %}
            <li class="pill">
              <span class="tag-text">{{ tag }}</span>
              <form action="/delete_tag" method="post" class="inline"
                   onsubmit="return confirm({{ (tr('tags.group.delete.confirm').replace('{group}', group)) | tojson }})">

                <input type="hidden" name="tag" value="{{ tag }}">
                <input type="hidden" name="group" value="{{ group }}">
                <input type="hidden" name="from_edit" value="{{ request.args.get('from_edit', '') }}">
                <button type="submit" title="Eliminar" class="text-red-600 font-bold">Ã—</button>
              </form>
            </li>
            {% endfor %}
          </ul>
        </div>
      </section>
      {% endfor %}
    </div>

    <div class="mt-8 text-center hidden sm:block">
      {% if return_to %}
        <a href="{{ url_for('edit_video', video_id=return_to) }}" class="text-blue-400 underline">{{ tr("tags.footer.back_edit") }}</a>
      {% else %}
        <a href="{{ url_for('index') }}" class="text-blue-400 underline">{{ tr("tags.footer.back_home") }}</a>
      {% endif %}
    </div>

    <!-- Barra sticky en mÃ³vil -->
    <div class="sm:hidden sticky-bar mt-6">
      <div class="max-w-screen-lg mx-auto px-3 py-3 flex items-center justify-between">
        <span class="text-xs text-gray-300">{{ tr("tags.mobile.done") }}</span>
        {% if return_to %}
          <a href="{{ url_for('edit_video', video_id=return_to) }}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">{{ tr("tags.mobile.back_edit") }}</a>
        {% else %}
          <a href="{{ url_for('index') }}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">{{ tr("tags.mobile.back_home") }}</a>
        {% endif %}
      </div>
    </div>

  </div>

  <script>
	// --- Colapsables con persistencia + textos desde data-* ---
	document.querySelectorAll('.collapse-btn').forEach(btn => {
	  const targetSel = btn.getAttribute('data-target');
	  const target = document.querySelector(targetSel);
	  if (!target) return;

	  const key = 'tags_collapse_' + targetSel.replace(/[^a-z0-9]/gi, '_');

	  const labelShow = btn.getAttribute('data-label-show') || "{{ tr('tags.collapse.show') }}";
	  const labelHide = btn.getAttribute('data-label-hide') || "{{ tr('tags.collapse.hide') }}";


	  const open = (localStorage.getItem(key) ?? '1') === '1';
	  target.style.display = open ? '' : 'none';
	  btn.textContent = open ? labelHide : labelShow;

	  btn.addEventListener('click', () => {
		const visible = target.style.display !== 'none';
		target.style.display = visible ? 'none' : '';
		btn.textContent = visible ? labelShow : labelHide;
		try { localStorage.setItem(key, visible ? '0' : '1'); } catch {}
	  });
	});


    // --- Buscador global: filtra tags y actualiza contadores por grupo ---
    const qInput = document.getElementById('buscarGlobal');
    const groupSections = Array.from(document.querySelectorAll('#groupsWrap section'));

    function updateCountsAndFilter() {
      const q = (qInput.value || '').toLowerCase().trim();
      groupSections.forEach(sec => {
        const pills = Array.from(sec.querySelectorAll('.pill'));
        const total = pills.length;
        let visible = 0;
        pills.forEach(li => {
          const t = li.querySelector('.tag-text').textContent.toLowerCase();
          const show = !q || t.includes(q);
          li.style.display = show ? '' : 'none';
          if (show) visible++;
        });
        const cVis = sec.querySelector('.count-visible');
        const cTot = sec.querySelector('.count-total');
        if (cVis) cVis.textContent = visible;
        if (cTot) cTot.textContent = total;
      });
    }
    qInput.addEventListener('input', updateCountsAndFilter);
    updateCountsAndFilter(); // Primera pasada

    // --- Preview en vivo del color del grupo ---
    document.querySelectorAll('.group-color-picker').forEach(picker => {
      picker.addEventListener('input', (e) => {
        const sec = e.target.closest('section');
        const title = sec.querySelector('.group-title');
        if (title) title.style.color = e.target.value;
        // tambiÃ©n actualizamos la banda izquierda
        sec.style.borderLeftColor = e.target.value;
      });
    });
	
  document.addEventListener("DOMContentLoaded", () => {
    const currentLang = "{{ lang }}";
    const sel = document.getElementById("tags-lang-select");
    if (!sel) return;

    // Setear valor inicial segÃºn lang actual
    if (currentLang) {
      sel.value = currentLang;
    }

    sel.addEventListener("change", async (e) => {
      const newLang = e.target.value;
      if (!newLang || newLang === currentLang) return;

      try {
        await fetch("/api/language", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ lang: newLang })
        });
      } catch (err) {
        console.error("Error cambiando idioma:", err);
      }

      // Recarga para aplicar traducciones en esta misma pÃ¡gina
      location.reload();
    });
  });
	
  </script>
</body>
</html>
