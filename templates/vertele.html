<!-- SPDX-License-Identifier: LicenseRef-TVArgenta-NC-Attribution-Consult-First
     Proyecto: TVArgenta â€” Retro TV | Autor: Ricardo Sappia (rsflightronics@gmail.com)
     Â© 2025. No comercial, atribuciÃ³n y consulta previa. TAL CUAL, sin garantÃ­as.
     Ver LICENSE para tÃ©rminos completos.
-->

<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ tr("vertele.page_title") }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tv-wrapper {
      max-width: 100%;
      aspect-ratio: 4 / 3;
    }
    @media (orientation: portrait) {
      .tv-wrapper {
        aspect-ratio: 3 / 4;
      }
    }
  </style>
</head>
<body class="bg-black text-white min-h-screen flex flex-col items-center justify-center p-4">

  <h1 class="text-2xl text-yellow-400 font-bold mb-4">{{ tr("vertele.header") }}</h1>
  
  <div class="flex items-center gap-4 mb-4">
	  <a href="{{ url_for('index') }}"
		 class="text-blue-400 hover:underline text-sm sm:text-base whitespace-nowrap">
		{{ tr("vertele.nav.back_home") }}
	  </a>

	  <select id="vertele-lang-select"
			  class="bg-gray-900 border border-gray-600 text-xs sm:text-sm px-2 py-1 rounded">
		<option value="es">ðŸ‡¦ðŸ‡· ES</option>
		<option value="en">ðŸ‡ºðŸ‡¸ EN</option>
		<option value="de">ðŸ‡©ðŸ‡ª DE</option>
	  </select>
	</div>

  <!-- CONTENEDOR DE VIDEO -->
  <div class="tv-wrapper w-full sm:w-4/5 md:w-2/3 lg:w-1/2 relative border-4 border-yellow-500 rounded-xl shadow-xl overflow-hidden">
    <video id="tv-video" class="w-full h-full object-contain bg-black" autoplay muted controls playsinline>
      Tu navegador no soporta video HTML5.
    </video>
  </div>

  <!-- INFO DEL VIDEO -->
  <div id="video-info" class="mt-4 text-center space-y-2 text-sm text-gray-300">
    <p id="info-title" class="text-lg font-bold text-white"></p>
    <p id="info-tags"></p>
    <p id="info-score" class="italic text-xs text-gray-400"></p>
  </div>
	<!-- SELECCIÃ“N DE CANAL -->
  <div id="canales-container" class="mb-6 text-center">
    <h2 class="text-lg text-green-400 font-bold mb-2">{{ tr("vertele.channel.title") }}</h2>
    <div id="canales-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4 justify-center"></div>
    <p id="canal-activo" class="text-sm text-gray-400 mt-2"></p>
  </div>
  <div class="flex gap-4 mt-6">
    <a href="{{ url_for('index') }}" class="text-blue-400 hover:underline text-sm">{{ tr("vertele.nav.back_home") }}</a>
  </div>

  <!-- BOTTOM CHANNEL CONTROLS (touch/click friendly) -->
  <div class="mt-4 w-full sm:w-4/5 md:w-2/3 lg:w-1/2">
    <div class="grid grid-cols-3 gap-3">
      <button id="btn-prev-channel" class="bg-gray-800 hover:bg-yellow-700 text-white px-4 py-3 rounded font-bold shadow">
        â—€ {{ tr("vertele.channel.prev") if tr else "Prev" }}
      </button>
      <button id="btn-refresh-video" class="bg-yellow-500 hover:bg-yellow-600 text-black px-4 py-3 rounded font-bold shadow">
        âŸ³ {{ tr("vertele.channel.btn_next") }}
      </button>
      <button id="btn-next-channel" class="bg-gray-800 hover:bg-yellow-700 text-white px-4 py-3 rounded font-bold shadow">
        {{ tr("vertele.channel.next") if tr else "Next" }} â–¶
      </button>
    </div>
  </div>

  <script>
	  const videoEl = document.getElementById("tv-video");
	  const infoTitle = document.getElementById("info-title");
	  const infoTags = document.getElementById("info-tags");
	  const infoScore = document.getElementById("info-score");
	  const canalActivoLabel = document.getElementById("canal-activo");
	  const canalesGrid = document.getElementById("canales-grid");
    const btnPrevChannel = document.getElementById("btn-prev-channel");
    const btnNextChannel = document.getElementById("btn-next-channel");
    const btnRefreshVideo = document.getElementById("btn-refresh-video");

    let channelList = []; // [{id, nombre, icono}]
    let currentChannelId = null;
    let channelSwitchBusy = false;
    let currentVideoId = null;

    function sortChannelIds(ids) {
    return [...ids].sort((a, b) => {
      const aNum = /^\d+$/.test(a);
      const bNum = /^\d+$/.test(b);

      if (aNum && bNum) return Number(a) - Number(b);
      if (aNum && !bNum) return -1;
      if (!aNum && bNum) return 1;
      return a.localeCompare(b, undefined, { sensitivity: "base" });
    });
    }

    function orderedChannelIds() {
    // /api/set_canal_activo only accepts channels from canales.json,
    // so keep cycling limited to user/configured channels here.
    return sortChannelIds(channelList.map(c => String(c.id || "")).filter(Boolean));
    }

    function loadNextVideo(retries = 0, force = false) {
    const url = force ? "/api/next_video?force=1" : "/api/next_video";
    fetch(url)
		  .then(res => {
			if (!res.ok) throw new Error("Error al buscar prÃ³ximo video");
			return res.json();
		  })
		  .then(data => {
      currentChannelId = String(data?.modo || currentChannelId || "");

      if (data.cooldown) {
        // Same behavior as player: retry shortly after cooldown window
        if (retries < 3) {
        setTimeout(() => loadNextVideo(retries + 1, force), 650);
        }
        return;
      }

			if (data.no_videos) {
			  videoEl.src = "";
			  infoTitle.textContent = "{{ tr('vertele.video.unsupported') }}";
			  infoTags.textContent = "{{ tr('vertele.video.try_other') }}";
			  infoScore.textContent = "";
			  return;
			}

			const videoUrl = data.video_url || `/videos/${data.video_id}.mp4`;
      currentVideoId = data.video_id || null;
			videoEl.src = videoUrl;
			videoEl.load();
			videoEl.volume = 0.5;
			videoEl.play();

			infoTitle.textContent = data.title || data.video_id.replace(/_/g, " ");
			infoTags.textContent = data.tags && data.tags.length
			  ? `ðŸ·ï¸ Tags: ${data.tags.join(", ")}`
			  : "ðŸ·ï¸ Sin tags";
			infoScore.textContent = data.score !== undefined
			  ? `ðŸ”¢ Score: ${data.score}`
			  : "";
		  })
		  .catch(err => {
			alert("No se pudo cargar el siguiente video.");
			console.error(err);
		  });
	  }

    async function loadNextVideoFromButton() {
    try {
      // Clear pending pick for current item to avoid immediate reuse when possible.
      if (currentVideoId) {
      await fetch("/api/played", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ video_id: currentVideoId })
      });
      }
    } catch (e) {
      console.warn("Could not report current video before next:", e);
    }

    loadNextVideo(0, true);
    }

	  videoEl.addEventListener("ended", () => {
		setTimeout(loadNextVideo, 500);
	  });

	  loadNextVideo();

    if (btnRefreshVideo) {
    btnRefreshVideo.addEventListener("click", loadNextVideoFromButton);
    }

    async function loadChannelsGrid() {
      try {
      const res = await fetch("/api/canales");
      if (!res.ok) throw new Error("{{ tr('vertele.channel.error') }}");
      const data = await res.json();

      if (!data || !Array.isArray(data.canales)) return;
      channelList = data.canales;
      canalesGrid.innerHTML = "";

      channelList.forEach(canal => {
        if (!canal.id) return;

        const btn = document.createElement("button");
        btn.textContent = `${canal.icono || "ðŸ“º"} ${canal.nombre}`;
        btn.setAttribute("aria-label", `Seleccionar canal ${canal.nombre}`);
        btn.className = "bg-gray-800 hover:bg-yellow-700 text-white px-4 py-2 rounded text-sm font-bold";
        btn.onclick = () => setCanalActivo(canal.id);
        canalesGrid.appendChild(btn);
      });

      canalActivoLabel.textContent = `ðŸ“¡ Canal actual: ${data.canal_activo_nombre}`;
      } catch (err) {
      console.error("Error al cargar canales:", err);
      }
    }

    loadChannelsGrid();

    function setCanalActivo(id) {
      return fetch("/api/set_canal_activo", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ canal_id: id })
      })
        .then(async (res) => {
		  const data = await res.json();
		  if (!res.ok || data?.error) {
			throw new Error(data?.error || "set_canal_activo failed");
		  }
		  return data;
		})
        .then(() => {
      currentChannelId = String(id);
      loadChannelsGrid();
      loadNextVideo();
        });
    }

  async function cycleChannel(delta) {
    if (channelSwitchBusy) return;
    channelSwitchBusy = true;

    try {
    if (!channelList.length) {
      await loadChannelsGrid();
    }

    const channels = orderedChannelIds();
    if (!channels.length) return;

    let current = String(currentChannelId || channels[0]);
    if (current === "3") current = "03";

    let idx = channels.indexOf(current);
    if (idx < 0) idx = 0;

    const nextId = channels[(idx + (delta > 0 ? 1 : -1) + channels.length) % channels.length];
    await setCanalActivo(nextId);
    } catch (e) {
    console.error("Error cycling channels:", e);
    } finally {
    channelSwitchBusy = false;
    }
  }

  if (btnPrevChannel) {
    btnPrevChannel.addEventListener("click", () => cycleChannel(-1));
  }
  if (btnNextChannel) {
    btnNextChannel.addEventListener("click", () => cycleChannel(+1));
  }
	
	(function() {
	  const sel = document.getElementById('vertele-lang-select');
	  if (!sel) return;

	  // Cargar idioma actual
	  fetch("/api/lang")
		.then(r => r.json())
		.then(data => {
		  if (data && data.lang && sel.querySelector(`option[value="${data.lang}"]`)) {
			sel.value = data.lang;
		  }
		})
		.catch(() => {});

	  // Cambiar idioma
	  sel.addEventListener('change', () => {
		const lang = sel.value;
		fetch("/api/language", {
		  method: "POST",
		  headers: { "Content-Type": "application/json" },
		  body: JSON.stringify({ lang })
		}).then(() => location.reload())
		  .catch(() => location.reload());
	  });
	})();
	
	
  </script>

</body>
</html>
