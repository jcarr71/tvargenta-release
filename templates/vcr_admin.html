<!-- SPDX-License-Identifier: LicenseRef-TVArgenta-NC-Attribution-Consult-First
     Proyecto: TVArgenta ‚Äî Retro TV | Autor: Ricardo Sappia (rsflightronics@gmail.com)
     ¬© 2025. No comercial, atribuci√≥n y consulta previa. TAL CUAL, sin garant√≠as.
     Ver LICENSE para t√©rminos completos.
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VCR Tape Management - TVArgenta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tape-card {
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .tape-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 200, 0, 0.3);
    }
    .scanning {
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body class="bg-black text-white font-mono min-h-screen p-4">
  <div class="max-w-4xl mx-auto">
    <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
      <h1 class="text-2xl sm:text-3xl text-yellow-400 font-bold flex items-center gap-3">
        <span class="text-4xl">üìº</span>
        VCR Tape Management
      </h1>
      <a href="{{ url_for('index') }}"
         class="text-blue-400 hover:underline text-sm sm:text-base whitespace-nowrap">
        ‚Üê Back to Dashboard
      </a>
    </header>

    <!-- NFC Reader Status -->
    <div id="reader-status" class="mb-6 p-4 rounded-lg border-2">
      <div class="flex items-center gap-3">
        <span id="reader-icon" class="text-3xl">üîå</span>
        <div>
          <div id="reader-text" class="font-bold">Checking NFC Reader...</div>
          <div id="reader-detail" class="text-sm text-gray-400"></div>
        </div>
      </div>
    </div>

    <!-- Scan New Tape Section -->
    <div class="bg-gray-900 border border-blue-600 rounded-lg p-6 mb-8 shadow-lg">
      <h2 class="text-xl font-bold text-blue-400 mb-4 flex items-center gap-2">
        <span>üîç</span> Register New Tape
      </h2>

      <div id="scan-section">
        <p class="text-gray-300 mb-4">Place an unregistered mini VHS tape on the NFC reader to scan it.</p>

        <div id="scan-waiting" class="hidden">
          <div class="flex items-center gap-3 text-yellow-400 scanning">
            <span class="text-2xl">üì°</span>
            <span>Waiting for tape...</span>
          </div>
        </div>

        <div id="scan-detected" class="hidden">
          <div class="bg-green-900 border border-green-500 rounded p-4 mb-4">
            <div class="flex items-center gap-2 text-green-400 font-bold mb-2">
              <span>‚úì</span> New Tape Detected!
            </div>
            <div class="text-sm">
              <span class="text-gray-400">UID:</span>
              <span id="detected-uid" class="font-mono text-white"></span>
            </div>
          </div>

          <form id="register-form" class="space-y-4">
            <input type="hidden" id="register-uid" name="uid">

            <div>
              <label class="block text-sm mb-1 text-gray-300">Select Video for this Tape:</label>
              <select id="register-video" name="video_id" required
                      class="w-full bg-gray-800 text-white px-3 py-2 rounded border border-gray-600 focus:border-blue-500">
                <option value="">-- Select a video --</option>
              </select>
            </div>

            <div>
              <label class="block text-sm mb-1 text-gray-300">Custom Title (optional):</label>
              <input type="text" id="register-title" name="title"
                     placeholder="Leave blank to use video title"
                     class="w-full bg-gray-800 text-white px-3 py-2 rounded border border-gray-600 focus:border-blue-500">
            </div>

            <button type="submit"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition">
              Register Tape
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Registered Tapes List -->
    <h2 class="text-xl font-bold text-yellow-400 mb-4 flex items-center gap-2">
      <span>üìö</span> Registered Tapes
    </h2>

    <div id="tapes-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
      <div class="text-gray-500 italic">Loading tapes...</div>
    </div>

    <!-- Current VCR State (Debug) -->
    <details class="mt-8">
      <summary class="text-gray-500 cursor-pointer hover:text-gray-300">Debug: VCR State</summary>
      <pre id="vcr-state-debug" class="bg-gray-900 p-4 rounded mt-2 text-xs overflow-auto max-h-64"></pre>
    </details>
  </div>

  <script>
    let videos = [];
    let lastUnknownUid = null;

    // Format duration as HH:MM:SS
    function formatDuration(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = Math.floor(seconds % 60);
      if (h > 0) {
        return `${h}h ${m}m`;
      }
      return `${m}m ${s}s`;
    }

    // Load available videos for dropdown
    async function loadVideos() {
      try {
        const res = await fetch('/api/vcr/videos');
        const data = await res.json();
        if (data.ok) {
          videos = data.videos || [];
          const select = document.getElementById('register-video');
          select.innerHTML = '<option value="">-- Select a video --</option>';
          videos.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.video_id;
            opt.textContent = `${v.title} (${formatDuration(v.duration)})`;
            select.appendChild(opt);
          });
        }
      } catch (e) {
        console.error('Failed to load videos:', e);
      }
    }

    // Load registered tapes
    async function loadTapes() {
      try {
        const res = await fetch('/api/vcr/tapes');
        const data = await res.json();
        const container = document.getElementById('tapes-list');

        if (!data.ok || !data.tapes || data.tapes.length === 0) {
          container.innerHTML = '<div class="text-gray-500 italic col-span-2">No tapes registered yet. Scan a tape above to register it.</div>';
          return;
        }

        container.innerHTML = data.tapes.map(tape => `
          <div class="tape-card bg-gray-900 border border-yellow-600 rounded-lg p-4 shadow-lg">
            <div class="flex items-start justify-between mb-2">
              <div class="flex items-center gap-2">
                <span class="text-2xl">üìº</span>
                <h3 class="font-bold text-white">${tape.title || tape.video_id}</h3>
              </div>
            </div>
            <div class="text-xs text-gray-400 mb-2 font-mono">${tape.uid}</div>
            <div class="text-sm text-gray-300 mb-2">
              <span class="text-yellow-400">Video:</span> ${tape.video_title || tape.video_id}
            </div>
            <div class="text-sm text-gray-300 mb-3">
              <span class="text-blue-400">Position:</span> ${formatDuration(tape.position_sec || 0)}
              ${tape.video_duration ? ` / ${formatDuration(tape.video_duration)}` : ''}
            </div>
            <div class="flex justify-end gap-3">
              <button onclick="resetTapePosition('${tape.uid}')"
                      class="text-yellow-400 hover:underline text-sm">
                Reset Position
              </button>
              <button onclick="deleteTape('${tape.uid}')"
                      class="text-red-400 hover:underline text-sm">
                Delete
              </button>
            </div>
          </div>
        `).join('');
      } catch (e) {
        console.error('Failed to load tapes:', e);
        document.getElementById('tapes-list').innerHTML =
          '<div class="text-red-400">Error loading tapes</div>';
      }
    }

    // Update reader status
    async function updateReaderStatus() {
      try {
        const res = await fetch('/api/vcr/state');
        const data = await res.json();

        const statusEl = document.getElementById('reader-status');
        const iconEl = document.getElementById('reader-icon');
        const textEl = document.getElementById('reader-text');
        const detailEl = document.getElementById('reader-detail');
        const debugEl = document.getElementById('vcr-state-debug');

        debugEl.textContent = JSON.stringify(data, null, 2);

        if (!data.ok) {
          statusEl.className = 'mb-6 p-4 rounded-lg border-2 border-red-600 bg-red-900/30';
          iconEl.textContent = '‚ùå';
          textEl.textContent = 'Error';
          detailEl.textContent = data.error || 'Unknown error';
          return;
        }

        if (!data.reader_attached) {
          statusEl.className = 'mb-6 p-4 rounded-lg border-2 border-gray-600 bg-gray-900/50';
          iconEl.textContent = 'üîå';
          textEl.textContent = 'NFC Reader Not Detected';
          detailEl.textContent = 'Connect your USB NFC reader to continue';
          document.getElementById('scan-waiting').classList.add('hidden');
          document.getElementById('scan-detected').classList.add('hidden');
        } else if (data.tape_inserted) {
          statusEl.className = 'mb-6 p-4 rounded-lg border-2 border-green-600 bg-green-900/30';
          iconEl.textContent = 'üìº';
          textEl.textContent = 'Tape Inserted';
          detailEl.textContent = `Playing: ${data.title || data.video_id}`;
          document.getElementById('scan-waiting').classList.add('hidden');
          document.getElementById('scan-detected').classList.add('hidden');
        } else if (data.unknown_tape_uid) {
          statusEl.className = 'mb-6 p-4 rounded-lg border-2 border-yellow-600 bg-yellow-900/30';
          iconEl.textContent = '‚ùì';
          textEl.textContent = 'Unregistered Tape Detected';
          detailEl.textContent = 'Register it below';

          // Show registration form
          document.getElementById('scan-waiting').classList.add('hidden');
          document.getElementById('scan-detected').classList.remove('hidden');
          document.getElementById('detected-uid').textContent = data.unknown_tape_uid;
          document.getElementById('register-uid').value = data.unknown_tape_uid;
          lastUnknownUid = data.unknown_tape_uid;
        } else {
          statusEl.className = 'mb-6 p-4 rounded-lg border-2 border-blue-600 bg-blue-900/30';
          iconEl.textContent = 'üì°';
          textEl.textContent = 'NFC Reader Ready';
          detailEl.textContent = 'Place a tape on the reader';
          document.getElementById('scan-waiting').classList.remove('hidden');
          document.getElementById('scan-detected').classList.add('hidden');
        }
      } catch (e) {
        console.error('Failed to get VCR state:', e);
      }
    }

    // Register tape form submission
    document.getElementById('register-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const uid = document.getElementById('register-uid').value;
      const videoId = document.getElementById('register-video').value;
      const title = document.getElementById('register-title').value;

      if (!uid || !videoId) {
        alert('Please select a video');
        return;
      }

      try {
        const res = await fetch('/api/vcr/tapes/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ uid, video_id: videoId, title: title || null })
        });

        const data = await res.json();
        if (data.ok) {
          alert('Tape registered successfully!');
          document.getElementById('register-form').reset();
          loadTapes();
          updateReaderStatus();
        } else {
          alert('Error: ' + (data.error || 'Unknown error'));
        }
      } catch (e) {
        console.error('Register failed:', e);
        alert('Failed to register tape');
      }
    });

    // Delete tape
    async function deleteTape(uid) {
      if (!confirm('Are you sure you want to delete this tape mapping?')) {
        return;
      }

      try {
        const res = await fetch(`/api/vcr/tapes/${encodeURIComponent(uid)}`, {
          method: 'DELETE'
        });
        const data = await res.json();
        if (data.ok) {
          loadTapes();
        } else {
          alert('Error: ' + (data.error || 'Unknown error'));
        }
      } catch (e) {
        console.error('Delete failed:', e);
        alert('Failed to delete tape');
      }
    }

    // Reset tape position
    async function resetTapePosition(uid) {
      if (!confirm('Reset this tape to the beginning?')) {
        return;
      }

      // For now, we'd need to add an API endpoint for this
      // This is a placeholder
      alert('Position reset not yet implemented');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadVideos();
      loadTapes();
      updateReaderStatus();

      // Poll for status updates
      setInterval(updateReaderStatus, 2000);
      setInterval(loadTapes, 10000);
    });
  </script>
</body>
</html>
