<!-- SPDX-License-Identifier: LicenseRef-TVArgenta-NC-Attribution-Consult-First
     Proyecto: TVArgenta â€” Retro TV | Autor: Ricardo Sappia (rsflightronics@gmail.com)
     Â© 2025. No comercial, atribuciÃ³n y consulta previa. TAL CUAL, sin garantÃ­as.
     Ver LICENSE para tÃ©rminos completos.
-->

<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
  <meta charset="UTF-8">
  <title>{{ tr("upload.page_title") }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .marquee-bar {
      height: 8px;
      background: repeating-linear-gradient(
        45deg,
        #facc15,
        #facc15 10px,
        #000 10px,
        #000 20px
      );
      background-size: 40px 100%;
      animation: marquee 0.5s linear infinite;
    }

    @keyframes marquee {
      from {
        background-position: 0 0;
      }
      to {
        background-position: 40px 0;
      }
    }
  </style>
  
	</head>
	<body class="bg-black text-white font-mono min-h-screen">
		<div class="max-w-screen-lg mx-auto py-6 sm:py-8 px-3 sm:px-6">
	<header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4 sm:mb-6">
	  <!-- TÃ­tulo -->
	  <h1 class="text-2xl sm:text-3xl font-bold text-yellow-400 leading-tight">
		{{ tr("upload.header") }}
	  </h1>

	  <!-- Back + idioma -->
	  <div class="flex items-center gap-4">
		<a href="{{ url_for('index') }}"
		   class="text-blue-400 underline text-sm sm:text-base whitespace-nowrap">
		  {{ tr("upload.nav.back_home") }}
		</a>

		<select id="upload-lang-select"
				class="bg-gray-900 border border-gray-600 text-xs sm:text-sm px-2 py-1 rounded">
		  <option value="es">ğŸ‡¦ğŸ‡· ES</option>
		  <option value="en">ğŸ‡ºğŸ‡¸ EN</option>
		  <option value="de">ğŸ‡©ğŸ‡ª DE</option>
		</select>
	  </div>
	</header>





    <!-- Mensaje de estado -->
    {% if request.args.get("ok") %}
    <div class="bg-green-600 text-white text-center font-bold py-2 mb-4 rounded">
      {{ tr("upload.status.ok") }}
    </div>
    {% elif request.args.get("error") == "hevc" %}
    <div class="bg-red-600 text-white text-center font-bold py-2 mb-4 rounded">
       {{ tr("upload.status.error_hevc") }}
    </div>
    {% elif request.args.get("error") %}
    <div class="bg-red-600 text-white text-center font-bold py-2 mb-4 rounded">
      âš ï¸ {{ request.args.get("error") }}
    </div>
    {% endif %}

    <!-- Estado de procesamiento -->
    <div id="uploadStatusBox" class="bg-gray-700 text-yellow-300 font-bold py-2 px-4 rounded mb-4 hidden"></div>

    <!-- Barrita animada -->
    <div id="loadingBar" class="hidden mb-4 marquee-bar rounded overflow-hidden"></div>

    <!-- Formulario -->
    <form id="uploadForm" method="POST" action="/upload" enctype="multipart/form-data"
          class="border-2 border-dashed border-yellow-500 rounded-lg p-6 bg-gray-800 text-center relative"
          ondrop="handleDrop(event)" ondragover="event.preventDefault()">

      <label for="fileInput" class="block cursor-pointer text-yellow-300 mb-4">
        {{ tr("upload.form.label") }}
      </label>

      <input type="file" id="fileInput" name="videos[]" accept=".mp4" multiple class="hidden"
             onchange="updateFileList(this.files)">
      
      <div id="fileList" class="text-sm text-gray-400 mt-2 italic">{{ tr("upload.form.no_files") }}</div>

      <button type="submit"
              class="mt-6 bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded">
        {{ tr("upload.form.button") }}
      </button>
    </form>

    <div class="mt-8 text-center">
      <a href="{{ url_for('index') }}" class="text-blue-400 underline">{{ tr("upload.nav.back_home") }}</a>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const fileList = document.getElementById("fileList");
    const form = document.getElementById("uploadForm");
    const loadingBar = document.getElementById("loadingBar");
    const statusBox = document.getElementById("uploadStatusBox");

    let polling = false;

    form.addEventListener("click", (e) => {
      if (fileInput.files.length === 0) {
        fileInput.click();
      }
    });

    form.addEventListener("submit", () => {
      loadingBar.classList.remove("hidden");
      statusBox.classList.remove("hidden");
      startStatusPolling();
    });

    function updateFileList(files) {
      if (files.length === 0) {
        fileList.textContent = "{{ tr('upload.form.no_files') }}";
        return;
      }
      let list = Array.from(files)
        .map(file => `â€¢ ${file.name}`)
        .join("<br>");
      fileList.innerHTML = list;
    }

    function handleDrop(e) {
      e.preventDefault();
      fileInput.files = e.dataTransfer.files;
      updateFileList(e.dataTransfer.files);
    }

    function startStatusPolling() {
      if (polling) return;
      polling = true;
      const interval = setInterval(() => {
        fetch("/upload_status")
          .then(res => res.text())
          .then(text => {
            statusBox.textContent = text;
            if (text.includes("{{ tr('upload.status.done_token') }}")) {
              clearInterval(interval);
              setTimeout(() => location.href = "/", 1500);
            }
          });
      }, 1500);
    }

    window.addEventListener("dragover", e => e.preventDefault());
    window.addEventListener("drop", e => e.preventDefault());
	
	document.addEventListener("DOMContentLoaded", () => {
	  const currentLang = "{{ lang }}";
	  const sel = document.getElementById("upload-lang-select");
	  if (sel && currentLang) {
		sel.value = currentLang;
	  }

	  if (sel) {
		sel.addEventListener("change", async (e) => {
		  const newLang = e.target.value;
		  if (!newLang || newLang === currentLang) return;
		  try {
			await fetch("/api/language", {
			  method: "POST",
			  headers: { "Content-Type": "application/json" },
			  body: JSON.stringify({ lang: newLang })
			});
		  } catch (err) {
			console.error("Error cambiando idioma:", err);
		  }
		  location.reload();
		});
	  }
	});
	
  </script>
</body>
</html>
